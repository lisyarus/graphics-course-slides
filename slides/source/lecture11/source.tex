% (c) Nikita Lisitsa, lisyarus@gmail.com, 2021

\documentclass{beamer}

\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}

\usepackage{graphicx}
\graphicspath{ {./images/} }

\usepackage{adjustbox}

\usepackage{color}
\usepackage{soul}

\usepackage{hyperref}

\usepackage{amsmath}

\usepackage{tikz}
\usetikzlibrary{decorations}
\usetikzlibrary{decorations.pathreplacing}
\usepackage{xifthen}

\definecolor{red}{rgb}{1,0,0}
\definecolor{green}{rgb}{0,0.5,0}
\definecolor{blue}{rgb}{0,0,1}
\definecolor{magenta}{rgb}{0.75,0,0.75}

\makeatletter
\newcommand{\slideimage}[1]{
  \begin{figure}
    \begin{adjustbox}{width=\textwidth, totalheight=\textheight-2\baselineskip-2\baselineskip,keepaspectratio}
      \includegraphics{#1}
    \end{adjustbox}
  \end{figure}
}
\makeatother

\title{Компьютерная графика}
\subtitle{Лекция 10: Gamma correction, sRGB, color banding, dithering, deferred shading, tiled/clustered shading}
\date{2021}

\setbeamertemplate{footline}[frame number]

\begin{document}

\frame{\titlepage}

\begin{frame}<1>[fragile,label=gamma]
\frametitle{Гамма}
\begin{itemize}
\item Обычно, интенсивность света \begin{math}I\end{math}, излучаемого монитором, нелинейно зависит от значения \begin{math}V\end{math}, записанного в пикселе
\pause
\item Это лучше соответствует восприятию света человеком
\pause
\item Почти всегда используется показательная функция:
\begin{equation}I \sim V^\gamma\end{equation}
\pause
\item \begin{math}\gamma\end{math} обычно равна 2.2 (некоторые компьютеры Macintosh использовали 1.8)
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Линейное значение пикселя vs линейная интенсивность излучения}
\begin{figure}
\slideimage{gamma-scale.png}
\end{figure}
\end{frame}

\againframe<2->{gamma}

\begin{frame}<1>[fragile,label=gamma2]
\frametitle{Проблемы гаммы}
\begin{itemize}
\item Картинка может издалека выглядеть ярче, чем её усреднённый вариант (e.g. mipmap)
\pause
\item Искажается восприятие относительных яркостей, особенно при реалистичном рендеринге (e.g. объект в два раза ярче не будет выглядеть в два раза ярче)
\pause
\item Неправильно выглядит освещение, наложение источников света, и т.д.
\end{itemize}
\end{frame}

\begin{frame}
\frametitle{Серый (цвет=0.5) квадрат и квадрат с мелкой шахматной раскраской}
\begin{figure}
\slideimage{gamma-checkers.png}
\end{figure}
\end{frame}

\againframe<2->{gamma2}

\begin{frame}[fragile]
\frametitle{Коррекция гаммы (gamma-correction)}
\begin{itemize}
\item Коррекция гаммы - общий термин для применения любых нелинейных преобразований над интенсивностью пикселя
\pause
\item В рендеринге под гамма-коррекцией обычно подразумевают применение обратного к \begin{math}V^{2.2}\end{math} преобразования, чтобы получить линейную зависимость выходящего излучения от значения пикселя
\pause
\item Делает картинку ярче и часто более реалистичной
\end{itemize}
\end{frame}

\begin{frame}[fragile]
\frametitle{Коррекция гаммы (gamma-correction)}
\begin{verbatim}
// Вычислили цвет пикселя
// с учётом освещения
vec3 color = ...;

color = pow(color, vec3(1.0 / 2.2));
\end{verbatim}
\end{frame}

\begin{frame}[fragile]
\frametitle{Эффекты коррекции гаммы}
\slideimage{gamma-ex1.png}
\end{frame}

\begin{frame}[fragile]
\frametitle{Эффекты коррекции гаммы}
\slideimage{gamma-ex2.png}
\end{frame}

\begin{frame}[fragile]
\frametitle{Эффекты коррекции гаммы}
\slideimage{gamma-ex3.png}
\end{frame}

\begin{frame}[fragile]
\frametitle{Коррекция гаммы: ссылки}
\begin{itemize}
\item \href{https://en.wikipedia.org/wiki/Gamma_correction}{en.wikipedia.org/wiki/Gamma\_correction}
\item \href{http://blog.johnnovak.net/2016/09/21/what-every-coder-should-know-about-gamma}{What every coder should know about gamma}
\item \href{http://filmicworlds.com/blog/linear-space-lighting-i-e-gamma}{Linear-space lighting (i.e. gamma)}
\item \href{https://learnopengl.com/Advanced-Lighting/Gamma-Correction}{Туториал на learnopengl.com}
\item \href{https://github.com/lisyarus/graphics-course-practice/tree/master/gamma-correction}{Пример с гамма-коррекцией}
\end{itemize}
\end{frame}

\begin{frame}[fragile]
\frametitle{sRGB}
\begin{itemize}
\item По тем же причинам, по которым существует нелинейная гамма у мониторов (отдать больше бит под тёмные цвета), хочется хранить текстуры не в сыром формате, а в гамма-преобразованном: значение пикселя \begin{math}V\end{math} зависит от желаемой интенсивности \begin{math}I\end{math} как \begin{math}V \sim I^\frac{1}{\gamma}\end{math}
\pause
\item Такой формат хранения цвета называется sRGB
\begin{itemize}
\item N.B. Точная формула преобразования sRGB отличается от \begin{math}I^\frac{1}{2.2}\end{math}, но очень близка к ней
\end{itemize}
\pause
\item Обычно изображения хранятся именно в таком формате
\pause
\item Проверить формат можно любым редактором изображений или программой \verb|identify| пакета \verb|imagemagick|
\end{itemize}
\end{frame}

\begin{frame}[fragile]
\frametitle{sRGB}
\begin{itemize}
\item При чтении из sRGB-текстуры нужно возводить прочитанное значение в степень 2.2
\pause
\item При записи в sRGB-текстуру нужно возводить записываемое значение в степень 1/2.2
\pause
\item В OpenGL есть поддержка sRGB для текстур и фреймбуферов
\end{itemize}
\end{frame}

\begin{frame}[fragile]
\frametitle{sRGB-текстуры}
\begin{itemize}
\item Специальное значение internal format для текстуры (\verb|GL_SRGB8| или \verb|GL_SRGB8_ALPHA8|) означает, что текстура хранит sRGB-значения - они будут \textit{автоматически} переведены в линейные значения (т.е. возведены в степень 2.2) при чтении из шейдера
\pause
\item \verb|glEnable(GL_FRAMEBUFFER_SRGB)| включит автоматическое обратное преобразование (возведение в степень 1/2.2) при рисовании в sRGB-текстуру
\pause
\item {\color{red}N.B.:} \verb|glGenerateMipmap| \textit{не обязан} правильно обрабатывать sRGB-текстуры!
\end{itemize}
\end{frame}

\begin{frame}[fragile]
\frametitle{sRGB-correct mipmap}
\slideimage{srgb-mipmap.png}
\end{frame}

\begin{frame}[fragile]
\frametitle{sRGB: ссылки}
\begin{itemize}
\item \href{https://en.wikipedia.org/wiki/SRGB}{en.wikipedia.org/wiki/SRGB}
\item \href{https://stackoverflow.com/a/12894053/2315602}{Подробный текст про sRGB на stackoverflow}
\item \href{https://www.khronos.org/opengl/wiki/Framebuffer#Colorspace}{sRGB framebuffers}
\end{itemize}
\end{frame}

\end{document}